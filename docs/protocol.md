# Protocol Description
**+++ DRAFT Version 1.0 +++**

StarCraft II can contact outer world by reading/writing from/to the data bank file.
Data bank is actually XML-file stored in specific location.

### Generic Data Bank Structure
Each data bank is an XML-file of the following structure:
 - Top-level: Element `Bank` (attributes: `version` = 1)
   - Array of elements `Section` (attributes: `name` - string)
     - Array of elements `Key` (attributes: `name` - string)
       - Single element `Value` with one of the following value-attributes:
         * `string` - Basic string w/o formatting
         * `text` - XML-Encoded string containing HTML-like rich text
         * `flag` - Used for Booleans
         * `int` - Used for Integer numbers
         * `fixed` - Used for Real numbers
         * `point` - Point in in format `{x},{y}`
       - Alternatively, `Key` may contain a number of unit-related fields
       if stored data is Unit.

All elements contain no inner data

#### Example Bank
```xml
<?xml version="1.0" encoding="utf-8"?>
<Bank version="1">
    <Section name="hero">
        <Key name="kills">
            <Value int="19"/>
        </Key>
    </Section>
    <Section name="meta">
        <Key name="unit">
            <Type string="ThorAP"/>
            <Shields fixed="0"/>
            <Life fixed="400"/>
            <Energy fixed="0"/>
            <XPCount int="0"/>
        </Key>
        <Key name="string">
            <Value string="some string"/>
        </Key>
        <Key name="boolean">
            <Value flag="1"/>
        </Key>
        <Key name="point">
            <Value point="56.2631,63.2812"/>
        </Key>
        <Key name="text">
            <Value text="&lt;s val=&quot;BoardTitle&quot;&gt;Some &lt;/s&gt;&lt;c val=&quot;00FFFF&quot;&gt;text&lt;/c&gt; with formatting"/>
        </Key>
        <Key name="real">
            <Value fixed="1.5"/>
        </Key>
        <Key name="integer">
            <Value int="-44"/>
        </Key>
    </Section>
</Bank>
```

## Interface Description
Here and below, the Bot would represent
any client interacting with the StarCraft bank files,
unless otherwise stated.

1. When connection establishes, the Meta section is filled.
2. Both clients periodically read & write the data bank file.
3. Events sent to the StarCraft are named Requests,
and events sent by the StarCraft are named Responses.
4. Each event has a unique EventID, which may be any string (UUID-4 recommended)
Response should have the same EventID as the Request it is generated by,
unless the Response is the generic event.

### Meta Section, Data Channel, Session Keel-Alive & Disconnection
1. When the game starts, it SHOULD wipe-out any existing bank data
and create a Meta (key: `meta`) section with the following content:
   - Protocol Version (key: `protocol-version`) - should be exactly `1.0`
   - Game ID (key: `game-id`) - a UUID-like string
   - Game Start Time (key: `start-time`) - an integer
     containing the timestamp in UNIX-format (seconds)
2. If, during session establishment, the Bot detects wrong protocol version,
it MUST immediately stop sending any events to the channel
and send a single event of type Disconnection with the Custom Data containing exactly the following:
    > "Unsupported protocol version: {}, expected: 1.0"
    
    Where `{}` should be replaced with the version it received.
3. When any client sends an event, it MUST:
   * Write the Request to the Section `request.{id}` or `response.{id}`
   (where `{id}` is the generated UUID-like EventID)
   * Write the value EventID at key EventID
   to the Section `events.requests` or `events.responses`,
   according to the event type (and create it if missing)
4. When any client reloads the bank file, it MUST:
   * Read all keys from the section `events.requests` or `events.responses`,
   according to the event type and store them as the EventIDs
   * Wipe out that section
   * For each loaded EventID:
     - Read appropriate event from section `request.{id}` or `response.{id}`
     - Delete that section
     - Apply the appropriate event handler
5. The Bot SHOULD send events of type Ping at least each 5 seconds.
6. If StarCraft did not receive any Ping Requests in 5 consequential seconds,
it SHOULD display a user warning or other informational message.
7. If the Bot did not receive any Ping Responses in 5 consequential seconds,
it SHOULD stop sending new Requests other than Pings.
Alternatively, the Bot MAY send a Disconnection Request
instead continuing sending Ping Requests.

### Event Model
This protocol is designed for issuing unit commands,
but it can easily be modified to transmit any data.

 - Every event is is the bank section
 called either `requests.{id}` (for Requests) or `response.{id}` (for Responses),
 where `{id}` is the EventID of the event.
 - The event MUST contain the following fields:
   * Event Type (key: `event-type`), a string field
   containing one of the allowed event types (see below)
 - The event MAY contain the following fields:
   * Event Result (key: `result`), a boolean field used for the Response events
   representing if the Request was handled without errors.
   * Event Owner (key: `owner-id`), a string field
   representing owner of the event (i.e., owner of unit that died)
   * Unit ID (key: `unit-id`), a string field
   representing unique internal identifier of unit
   (StarCraft II calls this "Unit Tag")
   * Custom Data (key: `custom-data`), a string field
   containing any extra data provided with the event
   (i.e., error message text, or filtering attributes)

### Event Types
The following applies to all Requests and only successful Responses (Result field is true)
For the failed Responses, Custom Data message is free.

|   Event Type  |  Event Type Key | Message Type | Owner ID | Unit ID | Custom Data                                                                   |
|:-------------:|:---------------:|:------------:|:--------:|:-------:|-------------------------------------------------------------------------------|
|      Ping     |      `ping`     |      Any     |    No    |    No   | Optionally: Current timestamp in UNIX-format (seconds)                        |
| Disconnection | `disconnection` |      Any     |    No    |    No   | Required: Reason                                                              |
| Allocate Unit | `allocate-unit` |    Request   |    Yes   |    No   | Optionally for Request: Space-separated *UnitTypeFilter* and *LocationFilter* |
| Allocate Unit | `allocate-unit` |   Response   |    Yes   |   Yes   | No                                                                            |
|  Issue Order  |  `issue-order`  |      Any     |    Yes   |   Yes   | Required for Request: Space-separated *AbilityID*, optionally *TargetID*      |
|  Revoke Owner |  `revoke-owner` |      Any     |    Yes   |   Yes   | No                                                                            |
|   Unit Dies   |   `unit-dies`   |   Response   |    Yes   |   Yes   | No                                                                            |

#### Protocol-related Events
##### Ping Events
Ping events are sent by the Bot to StarCraft, at least one each 5s.
All Ping Requests MUST be answered.

In addition, Ping events MAY contain the Custom Data of UNIX timestamp (in seconds)

##### Disconnection
Disconnection events MAY be sent by both clients.
The Custom Data field IS REQUIRED to contain the reason of channel termination.

#### Data-related Events
##### Allocate Unit
An Allocate Unit Request is sent by the Bot in order
to allocate single unit matching conditions (passed in the Custom Data).
Units those have already been allocated MUST NOT be returned by this event.
Filters format: **TBD**

##### Issue Order
Force the given unit to execute the order passed in the Custom Data field.
Order format: **TBD**

##### Revoke Owner
A Revoke Owner Request is sent by the Bot
when user marked as inactive and unit should be marked as free.
StarCraft MUST remove the linking between the given unit and given owner
and make the given unit allocatable for the Allocate Unit Requests

##### Unit Dies
An Unit Dies Response is sent by StarCraft
when the unit with active linking dies.
The Bot should also remove the linking.

### Examples
#### Allocate Unit Request:
```xml
<?xml version="1.0" encoding="utf-8"?>
<Bank version="1">
    <Section name="request.5a5174c1-1962-8192-9980-e2d62aa1d28e">
        <Key name="event-type">
            <Value string="allocate-unit"/>
        </Key>
        <Key name="custom-data">
            <Value string="ThorAP any"/>
        </Key>
        <Key name="owner-id">
            <Value string="user1"/>
        </Key>
    </Section>
    <Section name="events.requests">
        <Key name="5a5174c1-1962-8192-9980-e2d62aa1d28e">
            <Value string="5a5174c1-1962-8192-9980-e2d62aa1d28e"/>
        </Key>
    </Section>
</Bank>
```

#### Allocate Unit Response:
```xml
<?xml version="1.0" encoding="utf-8"?>
<Bank version="1">
    <Section name="response.5a5174c1-1962-8192-9980-e2d62aa1d28e">
        <Key name="event-type">
            <Value string="allocate-unit"/>
        </Key>
        <Key name="custom-data">
            <Value string=""/>
        </Key>
        <Key name="owner-id">
            <Value string="user1"/>
        </Key>
        <Key name="success">
            <Value flag="1"/>
        </Key>
        <Key name="unit-id">
            <Value string="524289"/>
        </Key>
    </Section>
    <Section name="events.responses">
        <Key name="5a5174c1-1962-8192-9980-e2d62aa1d28e">
            <Value string="5a5174c1-1962-8192-9980-e2d62aa1d28e"/>
        </Key>
    </Section>
</Bank>
```
